# -----------------------------------------------------------------------------
# PTSolns IDE - Native "Hook" Signing Build
# -----------------------------------------------------------------------------
name: PTSolns IDE

on:
  push:
    branches:
      - signing-lab
      - '[0-9]+.[0-9]+.x'
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'
    paths-ignore:
      - '.vscode/**'
      - 'docs/**'
      - 'scripts/**'
      - '!scripts/windowsCustomSign.js'
      - '!scripts/merge-channel-files.js'
      - 'static/**'
      - '*.md'

  workflow_dispatch:
    inputs:
      paid-runners:
        description: Include builds on non-free runners
        type: boolean
        default: false

  workflow_run:
    workflows:
      - Push Container Images
    branches:
      - main
    types:
      - completed

env:
  GO_VERSION: '1.21'
  NODE_VERSION: '18.17'
  YARN_VERSION: '1.22'
  JOB_TRANSFER_ARTIFACT_PREFIX: build-artifacts-
  CHANGELOG_ARTIFACTS: changelog
  STAGED_CHANNEL_FILE_ARTIFACT_PREFIX: staged-channel-file-

  BASE_BUILD_DATA: |
    - config:
        name: Windows
        runs-on: windows-latest
        container: null
        certificate-secret: INSTALLER_CERT_WINDOWS_CER
        certificate-password-secret: INSTALLER_CERT_WINDOWS_PASSWORD
        certificate-extension: pfx
        certificate-container: INSTALLER_CERT_WINDOWS_CONTAINER
        job-transfer-artifact-suffix: Windows_64bit
        mergeable-channel-file: 'false'
      artifacts:
        - path: '*Windows_64bit.exe'
          name: Windows_X86-64_interactive_installer
        - path: '*Windows_64bit.msi'
          name: Windows_X86-64_MSI
        - path: '*Windows_64bit.zip'
          name: Windows_X86-64_zip
    - config:
        name: Linux
        runs-on: ubuntu-latest
        container: { \"image\": \"ghcr.io/arduino/arduino-ide/linux:main\" }
        job-transfer-artifact-suffix: Linux_64bit
        mergeable-channel-file: 'false'
      artifacts:
        - path: '*Linux_64bit.zip'
          name: Linux_X86-64_zip
        - path: '*Linux_64bit.AppImage'
          name: Linux_X86-64_app_image
    - config:
        name: macOS x86
        runs-on: macos-15-intel
        container: null
        certificate-secret: APPLE_SIGNING_CERTIFICATE_P12
        certificate-password-secret: KEYCHAIN_PASSWORD
        certificate-extension: p12
        job-transfer-artifact-suffix: macOS_64bit
        mergeable-channel-file: 'true'
      artifacts:
        - path: '*macOS_64bit.dmg'
          name: macOS_X86-64_dmg
        - path: '*macOS_64bit.zip'
          name: macOS_X86-64_zip
    - config:
        name: macOS ARM
        runs-on: macos-latest
        container: null
        certificate-secret: APPLE_SIGNING_CERTIFICATE_P12
        certificate-password-secret: KEYCHAIN_PASSWORD
        certificate-extension: p12
        job-transfer-artifact-suffix: macOS_arm64
        mergeable-channel-file: 'true'
      artifacts:
        - path: '*macOS_arm64.dmg'
          name: macOS_arm64_dmg
        - path: '*macOS_arm64.zip'
          name: macOS_arm64_zip

  PAID_RUNNER_BUILD_DATA: |
    # (Kept empty/commented)

jobs:
  run-determination:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.determination.outputs.result }}
    permissions: {}
    steps:
      - name: Determine if the rest of the workflow should run
        id: determination
        run: |
          RELEASE_BRANCH_REGEX="refs/heads/[0-9]+.[0-9]+.x"
          if [[ "${{ github.event_name }}" != "create" || "${{ github.ref }}" =~ $RELEASE_BRANCH_REGEX ]]; then
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  build-type-determination:
    needs: run-determination
    if: needs.run-determination.outputs.result == 'true'
    runs-on: ubuntu-latest
    outputs:
      is-release: ${{ steps.determination.outputs.is-release }}
      is-nightly: ${{ steps.determination.outputs.is-nightly }}
      channel-name: ${{ steps.determination.outputs.channel-name }}
      publish-to-s3: ${{ steps.determination.outputs.publish-to-s3 }}
    environment: production
    permissions: {}
    steps:
      - name: Determine the type of build
        id: determination
        run: |
          if [[ "${{ startsWith(github.ref, 'refs/tags/') }}" == "true" ]]; then
            echo "is-release=true" >> $GITHUB_OUTPUT
            echo "is-nightly=false" >> $GITHUB_OUTPUT
            echo "channel-name=stable" >> $GITHUB_OUTPUT
          else
            echo "is-release=false" >> $GITHUB_OUTPUT
            echo "is-nightly=true" >> $GITHUB_OUTPUT
            echo "channel-name=nightly" >> $GITHUB_OUTPUT
          fi

  select-targets:
    needs: build-type-determination
    runs-on: ubuntu-latest
    outputs:
      artifact-matrix: ${{ steps.assemble.outputs.artifact-matrix }}
      build-matrix: ${{ steps.assemble.outputs.build-matrix }}
      merge-channel-files: ${{ steps.assemble.outputs.merge-channel-files }}
    permissions: {}
    steps:
      - name: Assemble target data
        id: assemble
        run: |
          build_matrix="$(echo "${{ env.BASE_BUILD_DATA }}" | yq --output-format json '[.[].config]')"
          artifact_matrix="$(echo "${{ env.BASE_BUILD_DATA }}" | yq --output-format json 'map(.artifacts[] + (.config | pick(["job-transfer-artifact-suffix"])))')"
          delimiter="$RANDOM"
          echo "build-matrix<<$delimiter" >> $GITHUB_OUTPUT
          echo "$build_matrix" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT
          echo "artifact-matrix<<$delimiter" >> $GITHUB_OUTPUT
          echo "$artifact_matrix" >> $GITHUB_OUTPUT
          echo "$delimiter" >> $GITHUB_OUTPUT
          echo "merge-channel-files=false" >> $GITHUB_OUTPUT

  build:
    name: build (${{ matrix.config.name }})
    needs: [build-type-determination, select-targets]
    environment: production
    permissions:
      id-token: write
      contents: read
    env:
      BUILD_ARTIFACTS_PATH: electron-app/dist/build-artifacts
      IS_WINDOWS_CONFIG: ${{ matrix.config.name == 'Windows' }}
      # Legacy Cert Variables (Required for fallback logic in the script)
      INSTALLER_CERT_WINDOWS_CER: "/tmp/cert.cer"
      WIN_CERT_PASSWORD: ${{ secrets[matrix.config.certificate-password-secret] }}
      WIN_CERT_CONTAINER_NAME: ${{ secrets[matrix.config.certificate-container] }}
      SIGNTOOL_PATH: "C:/Program Files (x86)/Windows Kits/10/bin/10.0.19041.0/x86/signtool.exe"
      PUPPETEER_SKIP_DOWNLOAD: true

    strategy:
      matrix:
        config: ${{ fromJson(needs.select-targets.outputs.build-matrix) }}

    runs-on: ${{ matrix.config.runs-on }}
    container: ${{ fromJSON(matrix.config.container) }}
    defaults:
      run:
        shell: bash
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: ${{ fromJSON(matrix.config.container) == null && 'yarn' || null }}

      - name: Install Yarn
        run: npm install --global "yarn@${{ env.YARN_VERSION }}"

      - name: Install Python 3.x
        if: fromJSON(matrix.config.container) == null
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.x'

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install Taskfile
        uses: arduino/setup-task@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: 3.x

      # -----------------------------------------------------------------------
      # 1. SETUP AZURE TRUSTED SIGNING (Windows Only)
      # -----------------------------------------------------------------------
      - name: Azure login (OIDC)
        if: matrix.config.name == 'Windows'
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          audience: api://AzureADTokenExchange

      - name: Install Azure Signing Tools
        if: matrix.config.name == 'Windows'
        shell: pwsh
        run: |
          # Download Azure SignTool Dlib
          nuget install Microsoft.Trusted.Signing.Client -Version 1.0.60 -OutputDirectory tools -ExcludeVersion
          $dlib = Join-Path $PWD "tools\Microsoft.Trusted.Signing.Client\bin\x64\Azure.CodeSigning.Dlib.dll"
          echo "AZURE_DLIB_PATH=$dlib" >> $env:GITHUB_ENV
          Write-Host "Azure Dlib Path: $dlib"

      - name: Create Azure Signing Metadata
        if: matrix.config.name == 'Windows'
        shell: pwsh
        run: |
          # Generate Metadata JSON for Azure
          $json = @{
            Endpoint = "${{ vars.TRUSTED_SIGNING_ENDPOINT }}"
            CodeSigningAccountName = "${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}"
            CertificateProfileName = "${{ vars.CERTIFICATE_PROFILE_NAME }}"
            CorrelationId = [guid]::NewGuid().ToString()
          } | ConvertTo-Json
          $path = Join-Path $PWD "azure-metadata.json"
          $json | Set-Content $path
          echo "AZURE_SIGNING_METADATA_PATH=$path" >> $env:GITHUB_ENV
          Write-Host "Azure Metadata created at: $path"

      # -----------------------------------------------------------------------
      # 2. Build & Package (ALL OS)
      # -----------------------------------------------------------------------
      - name: Package
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AC_USERNAME: ${{ secrets.AC_USERNAME }}
          AC_PASSWORD: ${{ secrets.AC_PASSWORD }}
          AC_TEAM_ID: ${{ secrets.AC_TEAM_ID }}
          IS_NIGHTLY: ${{ needs.build-type-determination.outputs.is-nightly }}
          IS_RELEASE: ${{ needs.build-type-determination.outputs.is-release }}
          CAN_SIGN: ${{ secrets[matrix.config.certificate-secret] != '' }}
        working-directory: ${{ matrix.config.working-directory || './' }}
        run: |
          # Export P12 for Mac/Legacy Windows
          if [ $CAN_SIGN = false ]; then
            echo "Skipping certificate export."
          else
            export CSC_LINK="${{ runner.temp }}/signing_certificate.${{ matrix.config.certificate-extension }}"
            echo "${{ secrets[matrix.config.certificate-secret] }}" | base64 --decode > "$CSC_LINK"
            export CSC_KEY_PASSWORD="${{ secrets[matrix.config.certificate-password-secret] }}"
            export CSC_FOR_PULL_REQUEST=true
          fi

          npx node-gyp install
          yarn install

          # --- Dependency Fixes (Crucial for Mac/Linux) ---
          yarn --cwd electron-app add reflect-metadata
          yarn --cwd arduino-ide-extension add inversify@5.1.1
          yarn --cwd arduino-ide-extension add typescript@4.9.5 --dev
          # ------------------------------------------------

          yarn --cwd arduino-ide-extension build
          yarn --cwd electron-app rebuild
          yarn --cwd electron-app build
          
          # This command triggers electron-builder.
          # On Windows, it calls ./scripts/windowsCustomSign.js using the vars we set above.
          yarn --cwd electron-app package

      # -----------------------------------------------------------------------
      # 3. Sign the Final Installer (Windows Only)
      #    This ensures the Setup.exe itself is signed, not just the inside files.
      #    We use 'v0' here to avoid YAML syntax errors.
      # -----------------------------------------------------------------------
      - name: Sign Windows installers (Azure Trusted Signing)
        if: matrix.config.name == 'Windows'
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ vars.TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}
          certificate-profile-name: ${{ vars.CERTIFICATE_PROFILE_NAME }}
          files-folder: ${{ matrix.config.working-directory && format('{0}/{1}', matrix.config.working-directory, env.BUILD_ARTIFACTS_PATH) || env.BUILD_ARTIFACTS_PATH }}
          files-folder-filter: exe,msi
          timestamp-url: http://timestamp.digicert.com

      # -----------------------------------------------------------------------
      # Upload & Merge steps (Standard)
      # -----------------------------------------------------------------------
      - name: Stage channel file for merge
        if: needs.select-targets.outputs.merge-channel-files == 'true' && matrix.config.mergeable-channel-file == 'true'
        working-directory: ${{ matrix.config.working-directory || './' }}
        run: |
          staged_channel_files_path="${{ runner.temp }}/staged-channel-files"
          mkdir "$staged_channel_files_path"
          mv "${{ env.BUILD_ARTIFACTS_PATH }}/${{ needs.build-type-determination.outputs.channel-name }}-mac.yml" "${staged_channel_files_path}/${{ needs.build-type-determination.outputs.channel-name }}-mac-${{ runner.arch }}.yml"
          echo "STAGED_CHANNEL_FILES_PATH=$staged_channel_files_path" >> "$GITHUB_ENV"

      - name: Upload staged-for-merge channel file artifact
        uses: actions/upload-artifact@v4
        if: needs.select-targets.outputs.merge-channel-files == 'true' && matrix.config.mergeable-channel-file == 'true'
        with:
          if-no-files-found: error
          name: ${{ env.STAGED_CHANNEL_FILE_ARTIFACT_PREFIX }}${{ matrix.config.job-transfer-artifact-suffix }}
          path: ${{ matrix.config.working-directory && format('{0}/{1}', matrix.config.working-directory, env.STAGED_CHANNEL_FILES_PATH) || env.STAGED_CHANNEL_FILES_PATH }}

      - name: Recalculate SHA512 hashes
        working-directory: ${{ matrix.config.working-directory || './' }}
        run: |
          ARTIFACTS_DIR="${{ env.BUILD_ARTIFACTS_PATH }}"
          find "$ARTIFACTS_DIR" \( -name "*.exe" -o -name "*.msi" -o -name "*.zip" -o -name "*.AppImage" -o -name "*.dmg" \) -type f -print0 | xargs -0 sha512sum > sha512sums.txt

      - name: Upload SHA512 checksums report
        uses: actions/upload-artifact@v4
        with:
          name: sha512sums-report-${{ matrix.config.job-transfer-artifact-suffix }}
          path: sha512sums.txt

      - name: Upload builds to job transfer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.JOB_TRANSFER_ARTIFACT_PREFIX }}${{ matrix.config.job-transfer-artifact-suffix }}
          path: ${{ matrix.config.working-directory && format('{0}/{1}', matrix.config.working-directory, env.BUILD_ARTIFACTS_PATH) || env.BUILD_ARTIFACTS_PATH }}

      - name: Manual Clean up for self-hosted runners
        if: runner.os == 'Windows' && matrix.config.working-directory
        shell: cmd
        run: rmdir /s /q "${{ matrix.config.working-directory }}\${{ env.BUILD_ARTIFACTS_PATH }}"

  merge-channel-files:
    needs: [build-type-determination, select-targets, build]
    if: needs.select-targets.outputs.merge-channel-files == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Set environment variables
        run: echo "CHANNEL_FILES_PATH=${{ runner.temp }}/channel-files" >> "$GITHUB_ENV"
      - uses: actions/checkout@v5
      - uses: actions/download-artifact@v5
        with:
          merge-multiple: true
          path: ${{ env.CHANNEL_FILES_PATH }}
          pattern: ${{ env.STAGED_CHANNEL_FILE_ARTIFACT_PREFIX }}*
      - uses: geekyeggo/delete-artifact@v5
        with:
          name: ${{ env.STAGED_CHANNEL_FILE_ARTIFACT_PREFIX }}*
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: arduino/setup-task@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          version: 3.x
      - if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libx11-dev libxkbfile-dev libsecret-1-dev
      - run: yarn
      - name: Update SHA512 sums
        working-directory: ${{ env.CHANNEL_FILES_PATH }}
        run: |
          ls -R ${{ env.CHANNEL_FILES_PATH }}
          declare -A HASHS
          for report in ${{ env.CHANNEL_FILES_PATH }}/sha512sums-report-*; do
            [ -f "$report" ] || continue
            while read -r hash filepath; do
              HASHS["$(basename "$filepath")"]="$hash"
            done < "$report"
          done
          for file in latest.yml stable.yml; do
            [ -f "$file" ] || continue
            for key in "${!HASHS[@]}"; do
               yq -i ".files[] |= if .url | basename == \"$key\" then .sha512 = \"${HASHS[$key]}\" else . end" "$file"
               yq -i "if .path | basename == \"$key\" then .sha512 = \"${HASHS[$key]}\" else . end" "$file"
            done
          done
      - run: node ./scripts/merge-channel-files.js --channel "${{ needs.build-type-determination.outputs.channel-name }}" --input "${{ env.CHANNEL_FILES_PATH }}"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.JOB_TRANSFER_ARTIFACT_PREFIX }}channel-files
          path: ${{ env.CHANNEL_FILES_PATH }}

  artifacts:
    needs: [select-targets, build]
    if: always() && needs.build.result != 'skipped'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        artifact: ${{ fromJson(needs.select-targets.outputs.artifact-matrix) }}
    steps:
      - uses: actions/download-artifact@v5
        with:
          name: ${{ env.JOB_TRANSFER_ARTIFACT_PREFIX }}${{ matrix.artifact.job-transfer-artifact-suffix }}
          path: build-artifacts
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact.name }}
          path: build-artifacts/${{ matrix.artifact.path }}

  changelog:
    needs: [build-type-determination, build]
    runs-on: ubuntu-latest
    outputs:
      BODY: ${{ steps.changelog.outputs.BODY }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - id: changelog
        env:
          IS_RELEASE: ${{ needs.build-type-determination.outputs.is-release }}
        run: |
          export LATEST_TAG=$(git describe --abbrev=0)
          export GIT_LOG=$(git log --pretty=" - %s [%h]" $LATEST_TAG..HEAD | sed 's/ *$//g')
          if [ "$IS_RELEASE" = true ]; then
            BODY="$GIT_LOG"
          else
            LATEST_TAG_WITH_LINK="[$LATEST_TAG](https://github.com/PTSolns/PTSolns-IDE/releases/tag/$LATEST_TAG)"
            if [ -z "$GIT_LOG" ]; then
                BODY="There were no changes since version $LATEST_TAG_WITH_LINK."
            else
                BODY="Changes since version $LATEST_TAG_WITH_LINK:\n$GIT_LOG"
            fi
          fi
          echo -e "$BODY"
          DELIMITER="$RANDOM"
          echo "BODY<<$DELIMITER" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "$DELIMITER" >> $GITHUB_OUTPUT
          echo "$BODY" > CHANGELOG.txt
      - if: needs.build-type-determination.outputs.is-nightly == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.JOB_TRANSFER_ARTIFACT_PREFIX }}changelog
          path: CHANGELOG.txt

  publish:
    needs: [build-type-determination, merge-channel-files, changelog]
    if: always() && needs.build-type-determination.result == 'success' && (needs.merge-channel-files.result == 'skipped' || needs.merge-channel-files.result == 'success') && needs.changelog.result == 'success' && needs.build-type-determination.outputs.publish-to-s3 == 'true' && needs.build-type-determination.outputs.is-nightly == 'true'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/download-artifact@v5
        with:
          merge-multiple: true
          path: build-artifacts
          pattern: ${{ env.JOB_TRANSFER_ARTIFACT_PREFIX }}*

  release:
    needs: [build-type-determination, merge-channel-files, changelog]
    if: always() && needs.build-type-determination.result == 'success' && (needs.merge-channel-files.result == 'skipped' || needs.merge-channel-files.result == 'success') && needs.changelog.result == 'success' && needs.build-type-determination.outputs.is-release == 'true'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/download-artifact@v5
        with:
          merge-multiple: true
          path: build-artifacts
          pattern: ${{ env.JOB_TRANSFER_ARTIFACT_PREFIX }}*
      - working-directory: build-artifacts
        run: |
          for file in stable*.yml; do [ -f "$file" ] && cp "$file" "${file/stable/latest}"; done
          for file in stable*.yml.blockmap; do [ -f "$file" ] && cp "$file" "${file/stable/latest}"; done
      - working-directory: build-artifacts
        shell: bash
        run: |
          set -euo pipefail
          EXE_PATH="$(find . -name '*Windows_64bit.exe' -print -quit)"
          if [ -n "$EXE_PATH" ]; then
            NEW_SHA512="$(openssl dgst -sha512 -binary "$EXE_PATH" | openssl base64 -A)"
            NEW_SIZE="$(wc -c < "$EXE_PATH" | tr -d ' ')"
            for YML_FILE in stable.yml latest.yml; do
              [ -f "$YML_FILE" ] || continue
              sed -i "/Windows_64bit\.exe/,/^[[:space:]]*sha512:/s|sha512:[[:space:]]*[[:alnum:]+/=]*|sha512: $NEW_SHA512|" $YML_FILE
              sed -i "/Windows_64bit\.exe/,+2 s/size: [0-9]*/size: $NEW_SIZE/" $YML_FILE
            done
          fi
      - id: tag_name
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      - uses: svenstaro/upload-release-action@2.9.0
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          release_name: ${{ steps.tag_name.outputs.TAG_NAME }}
          file: build-artifacts/*
          tag: ${{ github.ref }}
          file_glob: true
          body: ${{ needs.changelog.outputs.BODY }}

  clean:
    needs: [build, merge-channel-files, publish, release, artifacts]
    if: always() && needs.build.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - uses: geekyeggo/delete-artifact@v5
        with:
          name: ${{ env.JOB_TRANSFER_ARTIFACT_PREFIX }}*
