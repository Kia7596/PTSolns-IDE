name: PTSolns IDE (Windows only)

on:
  workflow_dispatch:
  push:
    branches:
      - test-test
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'

env:
  NODE_VERSION: '18.17'
  YARN_VERSION: '1.22'
  BUILD_ARTIFACTS_PATH: electron-app/dist/build-artifacts
  IS_WINDOWS_CONFIG: 'true'

jobs:
  build-windows:
    runs-on: windows-latest
    environment: production
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Install Yarn
        shell: bash
        run: npm install --global "yarn@${{ env.YARN_VERSION }}"

      - name: Build unpacked Windows payload (dir)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PUPPETEER_SKIP_DOWNLOAD: true
        run: |
          npx node-gyp install
          yarn install
          
          yarn --cwd arduino-ide-extension build
          yarn --cwd electron-app rebuild
          yarn --cwd electron-app build
          (cd electron-app && npx electron-builder --win --x64 --dir)

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          audience: api://AzureADTokenExchange

      - name: Sign payload (win-unpacked EXE/DLL)
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ vars.TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}
          certificate-profile-name: ${{ vars.CERTIFICATE_PROFILE_NAME }}
          files-folder: electron-app/dist/win-unpacked
          files-folder-filter: exe,dll

      - name: Sign payload (backend tools)
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ vars.TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}
          certificate-profile-name: ${{ vars.CERTIFICATE_PROFILE_NAME }}
          files-folder: electron-app/dist/win-unpacked/resources/app/lib/backend
          files-folder-filter: exe,dll

      - name: Sign payload (backend native)
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ vars.TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}
          certificate-profile-name: ${{ vars.CERTIFICATE_PROFILE_NAME }}
          files-folder: electron-app/dist/win-unpacked/resources/app/lib/backend/native
          files-folder-filter: exe,dll

      - name: Sign payload (backend resources)
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ vars.TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}
          certificate-profile-name: ${{ vars.CERTIFICATE_PROFILE_NAME }}
          files-folder: electron-app/dist/win-unpacked/resources/app/lib/backend/resources
          files-folder-filter: exe,dll

# ... existing signing steps ...

      - name: Sign payload (node_modules)
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ vars.TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}
          certificate-profile-name: ${{ vars.CERTIFICATE_PROFILE_NAME }}
          # TARGET THE NODE_MODULES FOLDER
          files-folder: electron-app/dist/win-unpacked/resources/app/node_modules
          # IMPORTANT: RECURSIVE IS REQUIRED to find deep files like @pingghost/protoc/bin/protoc.exe
          files-folder-recurse: true
          files-folder-filter: exe,dll

      # ... Verify payload signatures step ...
          
      - name: Sign payload (winpty Release)
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ vars.TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}
          certificate-profile-name: ${{ vars.CERTIFICATE_PROFILE_NAME }}
          files-folder: electron-app/dist/win-unpacked/resources/app/lib/build/Release
          files-folder-filter: exe,dll

      - name: Verify payload signatures
        shell: pwsh
        run: |
          $root = "electron-app/dist/win-unpacked"
          $r = Get-ChildItem $root -Recurse -Include *.exe,*.dll -File | % {
            $s = Get-AuthenticodeSignature $_.FullName
            [pscustomobject]@{ Status=$s.Status; Path=$_.FullName }
          }
          $r | Group-Object Status | % { "$($_.Name): $($_.Count)" }
          $bad = $r | Where-Object { $_.Status -ne "Valid" }
          $bad | Select-Object -First 200 | Format-Table -AutoSize
          if ($bad.Count -gt 0) { exit 1 }

      - name: Build installers from signed payload (prepackaged)
        shell: bash
        run: |
          cd electron-app
          npx electron-builder --win --x64 --prepackaged dist/win-unpacked

      - name: Collect installers
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force "electron-app/dist/installers" | Out-Null
          Copy-Item "electron-app/dist/*Setup*.exe" "electron-app/dist/installers/" -Force
          Copy-Item "electron-app/dist/*.msi"       "electron-app/dist/installers/" -Force
          Copy-Item "electron-app/dist/*win*.zip"   "electron-app/dist/installers/" -Force
          Copy-Item "electron-app/dist/*.yml"       "electron-app/dist/installers/" -Force
          Copy-Item "electron-app/dist/*.blockmap"  "electron-app/dist/installers/" -Force
          Get-ChildItem "electron-app/dist/installers" | Select-Object FullName

      - name: Sign installers (EXE/MSI)
        uses: azure/trusted-signing-action@v0
        with:
          endpoint: ${{ vars.TRUSTED_SIGNING_ENDPOINT }}
          trusted-signing-account-name: ${{ vars.TRUSTED_SIGNING_ACCOUNT_NAME }}
          certificate-profile-name: ${{ vars.CERTIFICATE_PROFILE_NAME }}
          files-folder: electron-app/dist/installers
          files-folder-filter: exe,msi

      - name: Mirror to build-artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force "electron-app/dist/build-artifacts" | Out-Null
          Copy-Item "electron-app/dist/installers/*" "electron-app/dist/build-artifacts/" -Force
          Get-ChildItem "electron-app/dist/build-artifacts" | Select-Object FullName

      - name: Recalculate SHA512 hashes
        shell: bash
        run: |
          ARTIFACTS_DIR="${{ env.BUILD_ARTIFACTS_PATH }}"
          find "$ARTIFACTS_DIR" \( -name "*.exe" -o -name "*.msi" -o -name "*.zip" -o -name "*.yml" -o -name "*.blockmap" \) -type f -print0 | xargs -0 sha512sum > sha512sums.txt

      - name: Upload SHA512 report
        uses: actions/upload-artifact@v4
        with:
          name: sha512sums-report-windows
          path: sha512sums.txt

      - name: Upload Windows build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-windows
          path: ${{ env.BUILD_ARTIFACTS_PATH }}
